<Page x:Class="RobloxAccountManager.Views.AccountsPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:vm="clr-namespace:RobloxAccountManager.ViewModels"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:converters="clr-namespace:RobloxAccountManager.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="500" d:DesignWidth="900">

    <Page.Resources>
        <CollectionViewSource x:Key="GroupedAccounts" Source="{Binding Accounts}" IsLiveGroupingRequested="True">
            <CollectionViewSource.LiveGroupingProperties>
                <sys:String>Group</sys:String>
            </CollectionViewSource.LiveGroupingProperties>
            <CollectionViewSource.GroupDescriptions>
                <PropertyGroupDescription PropertyName="Group"/>
            </CollectionViewSource.GroupDescriptions>
        </CollectionViewSource>
    </Page.Resources>

    <Grid Margin="20">
        <!-- Account List -->
        <ui:Card VerticalAlignment="Top" Padding="0">
            <ui:Card.Style>
                <Style TargetType="ui:Card">
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsBusy}" Value="True">
                           <Setter Property="Effect">
                               <Setter.Value>
                                   <BlurEffect Radius="10" KernelType="Gaussian"/>
                               </Setter.Value>
                           </Setter>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </ui:Card.Style>
            <Grid Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Text="Accounts" FontSize="20" FontWeight="SemiBold" Foreground="{DynamicResource TextFillColorPrimaryBrush}" Margin="0,0,0,15"/>

                <ListBox Grid.Row="1" ItemsSource="{Binding Source={StaticResource GroupedAccounts}}" 
                         Background="Transparent" BorderThickness="0" Margin="0,0,0,10"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListBox.GroupStyle>
                        <GroupStyle>
                            <GroupStyle.ContainerStyle>
                                <Style TargetType="{x:Type GroupItem}">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="{x:Type GroupItem}">
                                                <Expander IsExpanded="True" BorderThickness="0,0,0,1" BorderBrush="#33808080" Margin="0,0,0,10">
                                                    <Expander.Header>
                                                        <Grid HorizontalAlignment="Stretch">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="16" Foreground="{DynamicResource TextFillColorPrimaryBrush}" Margin="0,5,0,5" VerticalAlignment="Center"/>
                                                            
                                                            <Button Grid.Column="1" Content="Delete Group" Click="BtnDeleteGroup_Click" Tag="{Binding Name}" Margin="10,0,10,0" Padding="8,4" FontSize="11" 
                                                                    Visibility="{Binding Name, Converter={StaticResource GroupDeletionVisibilityConverter}}"
                                                                    Background="Transparent" BorderBrush="Red" Foreground="Red" BorderThickness="1"/>
                                                        </Grid>
                                                    </Expander.Header>
                                                    <ItemsPresenter />
                                                </Expander>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </GroupStyle.ContainerStyle>
                        </GroupStyle>
                    </ListBox.GroupStyle>

                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="Border"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                CornerRadius="4"
                                                Padding="{TemplateBinding Padding}"
                                                SnapsToDevicePixels="true">
                                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                              SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="#10FFFFFF"/>
                                            </Trigger>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="#20FFFFFF"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Margin" Value="0,1"/>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,5" Background="Transparent" ToolTip="Right-click for more options">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/> <!-- Avatar -->
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/> <!-- Edit Action -->
                                </Grid.ColumnDefinitions>
                                
                                <Grid.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Account Details" Click="BtnEditAccount_Click"/>
                                        <MenuItem Header="Move to Group..." SubmenuOpened="MnuMoveToGroup_SubmenuOpened">
                                            <MenuItem Header="Loading..."/> <!-- Placeholder -->
                                        </MenuItem>
                                        <MenuItem Header="Delete Account" Click="BtnDeleteAccount_Click" Foreground="Red"/>
                                    </ContextMenu>
                                </Grid.ContextMenu>

                                <CheckBox IsChecked="{Binding IsSelected}" VerticalAlignment="Center" Margin="0,0,15,0"/>
                                
                                <Ellipse Grid.Column="1" Width="40" Height="40" Margin="0,0,15,0">
                                    <Ellipse.Fill>
                                        <ImageBrush ImageSource="{Binding AvatarUrl}"/>
                                    </Ellipse.Fill>
                                </Ellipse>
                                
                                <StackPanel Grid.Column="2" VerticalAlignment="Center">
                                    <TextBlock FontSize="16" FontWeight="Medium" Foreground="{DynamicResource TextFillColorPrimaryBrush}">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="{Binding Username}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HasAlias}" Value="True">
                                                         <Setter Property="Text" Value="{Binding Alias}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    
                                    <TextBlock Text="{Binding Username}" FontSize="13" Foreground="#E0E0E0" Visibility="{Binding HasAlias, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    
                                    <!-- Description Display -->
                                    <TextBlock Text="{Binding Description}" FontSize="12" Foreground="#D0D0D0" TextTrimming="CharacterEllipsis" MaxWidth="400" HorizontalAlignment="Left" Margin="0,2,0,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Description}" Value="">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Description}" Value="{x:Null}">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>

                                <ui:Button Grid.Column="3" Click="BtnEditAccount_Click" Icon="{ui:SymbolIcon Edit24}" Appearance="Transparent" VerticalAlignment="Center" ToolTip="Edit Account Details"/>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <ui:Button Grid.Row="2" Click="BtnAddAccount_Click" Content="Add Account" Icon="{ui:SymbolIcon Add24}" Appearance="Secondary" HorizontalAlignment="Stretch"/>
            </Grid>
        </ui:Card>

        <!-- Progress Overlay -->
        <Grid Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" Background="#80000000" d:Visibility="Visible">
            <ui:ProgressRing IsIndeterminate="True" Width="50" Height="50" HorizontalAlignment="Center" VerticalAlignment="Center"/>
        </Grid>
    </Grid>
</Page>
