<Page x:Class="RobloxAccountManager.Views.ExploitsPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:vm="clr-namespace:RobloxAccountManager.ViewModels"
             xmlns:converters="clr-namespace:RobloxAccountManager.Converters"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    
    <Page.Resources>
        <converters:BoolToStringConverter x:Key="BoolToStringConverter"/>
        <converters:BoolToColorConverter x:Key="BoolToColorConverter"/>
        <converters:BoolToInfoBadgeSeverityConverter x:Key="BoolToInfoBadgeSeverityConverter"/>
    </Page.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
            <ui:Button Icon="{ui:SymbolIcon ArrowLeft24}" Command="{Binding NavigateBackCommand}" Appearance="Secondary" Margin="0,0,15,0"/>
            <TextBlock Text="Executor Status" FontSize="20" FontWeight="Bold" VerticalAlignment="Center" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
        </StackPanel>

        <!-- Exploit List in Card -->
        <ui:Card Grid.Row="1" Padding="0" VerticalAlignment="Stretch">
            <ui:DataGrid ItemsSource="{Binding ExploitsView}" 
                         AutoGenerateColumns="False" 
                         HeadersVisibility="Column"
                         GridLinesVisibility="Horizontal"
                         BorderThickness="0"
                         CanUserAddRows="False"
                         CanUserDeleteRows="False"
                         IsReadOnly="True"
                         SelectionMode="Single">
                
                <ui:DataGrid.GroupStyle>
                    <GroupStyle>
                        <GroupStyle.HeaderTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource PaletteColorPrimaryBrush}" Opacity="0.1" Padding="10,8" CornerRadius="4" Margin="0,5,0,5">
                                    <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="16"/>
                                </Border>
                            </DataTemplate>
                        </GroupStyle.HeaderTemplate>
                    </GroupStyle>
                </ui:DataGrid.GroupStyle>

                <ui:DataGrid.Columns>
                    <!-- Name -->
                    <DataGridTemplateColumn Header="Name" Width="180">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Title}" FontWeight="SemiBold" VerticalAlignment="Center" Margin="10,0"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Type -->
                    <DataGridTemplateColumn Header="Type" Width="100">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <ui:Card Padding="6,2" BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}" BorderThickness="1" Margin="5,0">
                                    <TextBlock Text="{Binding TypeDisplay}" HorizontalAlignment="Center" FontSize="12"/>
                                </ui:Card>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Status -->
                    <DataGridTemplateColumn Header="Status" Width="120">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <ui:InfoBadge Value="{Binding IsUpdated, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Updated|Patched'}"
                                              Severity="{Binding IsUpdated, Converter={StaticResource BoolToInfoBadgeSeverityConverter}}"
                                              HorizontalAlignment="Center" Margin="5,0"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Detected -->
                    <DataGridTemplateColumn Header="Detected" Width="120">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <ui:InfoBadge Value="{Binding IsDetected, Converter={StaticResource BoolToStringConverter}, ConverterParameter='DETECTED|Safe'}"
                                              Severity="{Binding IsDetected, Converter={StaticResource BoolToInfoBadgeSeverityConverter}, ConverterParameter='Inverse'}"
                                              HorizontalAlignment="Center" Margin="5,0"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Cost" Binding="{Binding Cost}" Width="100"/>
                    <DataGridTextColumn Header="UNC / sUNC" Binding="{Binding UncDisplay}" Width="180"/>
                    <DataGridTextColumn Header="Features" Binding="{Binding FeaturesDisplay}" Width="150"/>
                    <DataGridTextColumn Header="Version" Binding="{Binding Version}" Width="100"/>
                    <DataGridTextColumn Header="Last Updated" Binding="{Binding UpdatedDate}" Width="180"/>
                    
                    <!-- Actions -->
                    <DataGridTemplateColumn Header="Actions" Width="90">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <ui:Button Content="Visit" Icon="{ui:SymbolIcon Globe24}" 
                                           Command="{Binding DataContext.OpenLinkCommand, RelativeSource={RelativeSource AncestorType=ui:DataGrid}}" 
                                           CommandParameter="{Binding WebsiteLink}" 
                                           Width="80" Appearance="Secondary" Padding="5,2" Margin="5,0"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </ui:DataGrid.Columns>
            </ui:DataGrid>
        </ui:Card>

        <!-- Footer -->
        <Grid Grid.Row="2" Margin="0,15,0,0">
             <TextBlock Text="{Binding StatusMessage}" Foreground="{DynamicResource TextFillColorSecondaryBrush}" VerticalAlignment="Center"/>
             <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                 <ui:Button Content="Refresh" Icon="{ui:SymbolIcon ArrowSync24}" Command="{Binding LoadStatusesCommand}" Width="100"/>
             </StackPanel>
        </Grid>
    </Grid>
</Page>
