using System.Windows;
using System.Windows.Data;
using System.ComponentModel;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using RobloxAccountManager.Models;
using RobloxAccountManager.Services;
using System.Linq;

namespace RobloxAccountManager.ViewModels
{
    public partial class ExploitStatusViewModel : ObservableObject
    {
        private readonly ExploitStatusService _statusService;

        [ObservableProperty]
        private string _statusMessage;

        [ObservableProperty]
        private bool _isLoading;

        public ObservableCollection<ExploitStatus> Exploits { get; } = new ObservableCollection<ExploitStatus>();
        
        public ICollectionView ExploitsView { get; }

        private readonly MainViewModel _mainViewModel;

        public ExploitStatusViewModel(MainViewModel main)
        {
            _mainViewModel = main;
            _statusService = new ExploitStatusService();
            _statusMessage = "Loading status...";
            

            ExploitsView = CollectionViewSource.GetDefaultView(Exploits);
            ExploitsView.GroupDescriptions.Add(new PropertyGroupDescription(nameof(ExploitStatus.Platform)));
            
            _ = LoadStatusesAsync();
        }

        [RelayCommand]
        public async Task LoadStatusesAsync()
        {
            try
            {
                IsLoading = true;
                StatusMessage = "Fetching data...";
                

                Application.Current.Dispatcher.Invoke(() => Exploits.Clear());

                LogService.Log("Fetching exploit statuses...");
                var list = await _statusService.GetExploitStatusesAsync();
                LogService.Log($"Fetched {list.Count} exploits.");
                

                Application.Current.Dispatcher.Invoke(() => 
                {
                    foreach (var item in list)
                    {
                        if (item != null)
                        {
                            Exploits.Add(item);
                        }
                    }
                });

                StatusMessage = $"Loaded {list.Count} exploits.";
                IsLoading = false;
            }
            catch (System.Exception ex)
            {
                LogService.Error($"Critical Error in Exploit Status: {ex.Message}");
                StatusMessage = "Error loading data.";
                IsLoading = false;
            }
        }

        [RelayCommand]
        public void OpenLink(string url)
        {
            if (!string.IsNullOrEmpty(url) && url.StartsWith("http"))
            {
                try
                {
                    System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo(url) { UseShellExecute = true });
                }
                catch { }
            }

        }

        [RelayCommand]
        public void NavigateBack()
        {
            _mainViewModel?.NavigateAccounts();
        }
    }
}
